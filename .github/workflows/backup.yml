name: Database Backup

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            /opt/scale-app/scripts/backup-db.sh
          EOF

      - name: Download backup
        run: |
          DATE=$(date +%Y-%m-%d)
          scp -i ~/.ssh/deploy_key \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/scale-app/backups/db-backup-${DATE}.sql.gz \
            ./

      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_number }}
          path: db-backup-*.sql.gz
          retention-days: 30
